<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Upload to Azure Blob Storage</title>
    <!-- Google Fonts: Poppins and Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>

        body {
            font-family: 'Poppins', 'Noto Sans Thai', Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #f8f9fa;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            margin-bottom: 32px; /* Move header down by 2 space units (2 x 16px) */

        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }

        .container {
            position: relative;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            border: 3px dashed #6c757d;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #495057;
            background: #e9ecef;
        }

        .upload-area.dragover {
            border-color: #495057;
            background: #dee2e6;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3em;
            color: #495057;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #6c757d;
            font-size: 1em;
        }

        .file-input {
            display: none;
        }

        .selected-file {
            background: #dbf3f3;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 15px;
        }

        .file-info {
            flex-grow: 1;
        }

        .file-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .file-size {
            font-size: 0.9em;
            color: #6c757d;
        }

        .remove-file {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-file:hover {
            background: #c82333;
        }

        .options {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            height: auto;
            margin-top: 0;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .checkbox-wrapper label {
            color: #495057;
            font-weight: 500;
            cursor: pointer;
        }

        .upload-btn {
            background: linear-gradient(135deg, #3faebc 0%, #0cb4c3 100%);
            color: rgb(254, 254, 254);
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .upload-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .upload-btn:disabled {
            background: #749090;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #495057, #6c757d);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .result-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .result-message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result-message.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .result-message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .files-list-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .files-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .files-list-header h2 {
            color: #495057;
        }

        .refresh-btn {
            background: #d6dde3;
            color: #17a2b8;
            border: 1.5px solid #d4dede;
            padding: 8px 18px;
            height: 40px;
            min-width: 40px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none;
            box-sizing: border-box;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-top: -16px;
        }
        
        .refresh-btn:hover {
            background: #f8f9fa;
            border-color: #17a2b8;
            color: #138496;
        }
        
        .refresh-btn:active {
            background: #e9ecef;
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .refresh-svg {
            transition: transform 0.3s ease;
        }
        
        .refresh-btn:hover .refresh-svg {
            transform: rotate(-30deg);
        }
        
        .refresh-btn.spinning .refresh-svg {
            animation: spin 0.8s linear infinite;
        }
        #uploadContainerSelect {
            width: 100%;
            min-width: 220px;
            max-width: 600px;
            border: 1.5px solid #ced4da;
            border-radius: 8px;
            background: white;
            padding: 8px 18px;
            font-size: 1em;
            height: 40px;
            box-sizing: border-box;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .files-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .file-icon {
            font-size: 1.5em;
            color: #dc3545;
        }

        .back-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            text-decoration: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 1em;
            color: #495057;
        }

        select:not(#uploadContainerSelect) {
            width: 100%;
            padding: 8px 18px;
            border: 1.5px solid #17a2b8;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1em;
            color: #495057;
            background: white;
            height: 40px;
            box-sizing: border-box;
            line-height: 1.5;
            vertical-align: middle;
            white-space: normal;
            text-overflow: unset;
            overflow: visible;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .upload-section,
            .files-list-section {
                padding: 20px;
            }

            .options {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="/static/dashboard.html" class="back-btn">← Back to Dashboard</a>
        <div class="header">

            <h1 style="margin-top: 70px; margin-bottom: 0;">📄 PDF Upload</h1>
            <p>Upload PDF documents to Azure Blob Storage</p>
        </div>

        <div class="content">

            <div class="upload-section">
                <div>
                    <h3 style="margin-bottom:18px;font-size:1.2em;color:#495057;">Choose a PDF from Server Folder</h3>
                    <div id="serverDocIcons"
                        style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:22px;margin-bottom:18px;">
                    </div>
                <div style="margin-top: 8px;"></div>
                    <!-- PDF preview removed -->
                    <div class="selected-file" id="selectedFile" style="display:none;">
                        <div class="file-info">
                            <div class="file-name" id="fileName"></div>
                            <div id="renameInputs" style="margin-top:10px;"></div>
                        </div>
                        <button class="remove-file" id="removeFile">×</button>
                    </div>
                </div>

                <div class="options">
                    <div style="display: flex; flex-direction: column; gap: 16px; width: 100%;">
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label for="uploadContainerSelect" style="margin-bottom: 0; font-weight: 600; color: #495057;">Upload to Container:</label>
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                <select id="uploadContainerSelect" style="flex: 1 1 300px; min-width: 220px; max-width: 600px;">
                                    <option value="">Select container...</option>
                                </select>
                                <div class="checkbox-wrapper" style="margin-left: 0;">
                                    <input type="checkbox" id="overwriteCheck" />
                                    <label for="overwriteCheck">Overwrite if file exists</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="upload-btn" id="uploadBtn" disabled>Upload PDF</button>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="result-message" id="resultMessage"></div>
            </div>

            <div class="files-list-section">
                <div class="files-list-header">
                    <h2>📋 Container Files</h2>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 18px;">
                    <select id="containerSelect" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 8px; min-width: 150px; margin-right: 8px;">
                        <option value="">Loading containers...</option>
                        <!-- Style for full width -->
                        style="width: 100%; min-width: 220px; max-width: 600px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 8px; margin-right: 8px;"
                    </select>
                    <button class="refresh-btn" id="refreshBtn" title="Refresh Files" aria-label="Refresh Files">
                        <svg class="refresh-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="m16 8 5 0 0-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="m8 16-5 0 0 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <div class="container-files-message" id="containerFilesMessage" style="display:none;margin-bottom:10px;"></div>
                <div class="files-list" id="filesList">
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        Loading files...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const serverDocIcons = document.getElementById('serverDocIcons');
        const selectedFile = document.getElementById('selectedFile');
        const fileName = document.getElementById('fileName');
        const removeFile = document.getElementById('removeFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const overwriteCheck = document.getElementById('overwriteCheck');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const resultMessage = document.getElementById('resultMessage');
        const filesList = document.getElementById('filesList');
        const refreshBtn = document.getElementById('refreshBtn');
        const fileFilter = document.getElementById('fileFilter');
        const containerSelect = document.getElementById('containerSelect');
        const uploadContainerSelect = document.getElementById('uploadContainerSelect');

        let currentFile = null;
        let selectedServerDocs = [];
        let renameMap = {};
        let allFiles = [];
        let containers = [];

        // Show message in the container files section
        function showContainerFilesMessage(message, type) {
            const msgDiv = document.getElementById('containerFilesMessage');
            msgDiv.textContent = message;
            msgDiv.style.display = 'block';
            msgDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            msgDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
            msgDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            msgDiv.style.padding = '10px 16px';
            msgDiv.style.borderRadius = '8px';
            if (window._containerMsgTimeout) clearTimeout(window._containerMsgTimeout);
            window._containerMsgTimeout = setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 3000);
        }

        // Load document list from /list-documents and allow selection
        function setupServerDocPicker() {
            fetch('/upload-pdf/list-documents')
                .then(res => res.json())
                .then(docs => {
                    serverDocIcons.innerHTML = '';
                    if (docs.length === 0) {
                        serverDocIcons.innerHTML = '<div style="color:#6c757d;">No documents found</div>';
                    } else {
                        docs.forEach(doc => {
                            const iconDiv = document.createElement('div');
                            iconDiv.style.display = 'flex';
                            iconDiv.style.flexDirection = 'column';
                            iconDiv.style.alignItems = 'center';
                            iconDiv.style.cursor = 'pointer';
                            iconDiv.style.background = '#fff';
                            iconDiv.style.border = '1.5px solid #e9ecef';
                            iconDiv.style.borderRadius = '12px';
                            iconDiv.style.padding = '18px 8px 10px 8px';
                            iconDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.06)';
                            iconDiv.style.transition = 'border 0.2s, box-shadow 0.2s';
                            iconDiv.style.marginBottom = '0';
                            iconDiv.title = doc;
                            iconDiv.innerHTML = `<div style="font-size:2.2em;margin-bottom:8px;">📄</div><div style="width:100%;text-align:center;"><span style="font-size:0.98em;color:#495057;word-break:break-all;white-space:pre-wrap;">${doc}</span></div>`;
                            // Download button (SVG icon) below filename
                            const filenameLine = iconDiv.querySelector('div:nth-child(2)');
                            const downloadBtn = document.createElement('button');
                            downloadBtn.innerHTML = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 16V4M12 16L7 11M12 16L17 11" stroke="#138496" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="18" width="16" height="2" rx="1" fill="#138496"/></svg>`;
                            downloadBtn.title = 'Download';
                            downloadBtn.style.border = 'none';
                            downloadBtn.style.background = 'transparent';
                            downloadBtn.style.cursor = 'pointer';
                            downloadBtn.style.padding = '0';
                            downloadBtn.style.marginTop = '6px';
                            downloadBtn.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                const filepath = `/storage/app/public/chat_files/${doc}`;
                                window.open(`/upload-pdf/download-document?filepath=${encodeURIComponent(filepath)}`);
                            });
                            // Place download icon below filename
                            filenameLine.appendChild(document.createElement('br'));
                            filenameLine.appendChild(downloadBtn);
                            iconDiv.addEventListener('click', () => {
                                // Toggle selection
                                if (selectedServerDocs.includes(doc)) {
                                    selectedServerDocs = selectedServerDocs.filter(d => d !== doc);
                                    iconDiv.style.border = '1.5px solid #e9ecef';
                                    iconDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.06)';
                                } else {
                                    selectedServerDocs.push(doc);
                                    iconDiv.style.border = '2.5px solid #138496';
                                    iconDiv.style.boxShadow = '0 4px 16px rgba(19,132,150,0.12)';
                                }
                                // Show selected files
                                if (selectedServerDocs.length > 0) {
                                    fileName.textContent = selectedServerDocs.join(', ');
                                    selectedFile.style.display = 'flex';
                                    uploadBtn.disabled = false;
                                    // Show rename inputs for each selected file
                                    const renameInputs = document.getElementById('renameInputs');
                                    renameInputs.innerHTML = '';
                                    selectedServerDocs.forEach(doc => {
                                        const wrapper = document.createElement('div');
                                        wrapper.style.display = 'flex';
                                        wrapper.style.alignItems = 'center';
                                        wrapper.style.gap = '8px';
                                        wrapper.style.marginBottom = '6px';
                                        const label = document.createElement('label');
                                        label.textContent = 'Rename:';
                                        label.style.fontSize = '0.95em';
                                        label.style.color = '#495057';
                                        label.style.marginRight = '6px';
                                        const input = document.createElement('input');
                                        input.type = 'text';
                                        input.value = renameMap[doc] || doc;
                                        input.style.width = '100%';
                                        input.style.minWidth = '220px';
                                        input.style.maxWidth = '600px';
                                        input.style.flex = '1 1 auto';
                                        input.style.padding = '6px 12px';
                                        input.style.borderRadius = '5px';
                                        input.style.border = '1px solid #ced4da';
                                        input.style.fontSize = '1em';
                                        input.addEventListener('input', (e) => {
                                            renameMap[doc] = e.target.value;
                                        });
                                        wrapper.appendChild(label);
                                        wrapper.appendChild(input);
                                        renameInputs.appendChild(wrapper);
                                    });
                                } else {
                                    fileName.textContent = '';
                                    selectedFile.style.display = 'none';
                                    uploadBtn.disabled = true;
                                    document.getElementById('renameInputs').innerHTML = '';
                                }
                            });
                            serverDocIcons.appendChild(iconDiv);
                        });
                    }
                })
                .catch(() => {
                    serverDocIcons.innerHTML = '<div style="color:#dc3545;">Error loading documents</div>';
                });
        }

        // Remove file handler
        removeFile.addEventListener('click', () => {
            selectedServerDocs = [];
            renameMap = {};
            selectedFile.style.display = 'none';
            uploadBtn.disabled = true;
            Array.from(serverDocIcons.children).forEach(child => {
                child.style.border = '1.5px solid #e9ecef';
                child.style.boxShadow = '0 2px 8px rgba(0,0,0,0.06)';
            });
            document.getElementById('renameInputs').innerHTML = '';
        });

        // Upload button handler
        uploadBtn.addEventListener('click', async () => {
            if (!selectedServerDocs.length) return;
            const selectedContainer = uploadContainerSelect.value;
            if (!selectedContainer) {
                showResult('Please select a container to upload to!', 'error');
                return;
            }
            uploadBtn.disabled = true;
            progressBar.style.display = 'block';
            hideResult();
            let successCount = 0;
            let failCount = 0;
            let alreadyExistsFiles = [];
            for (const doc of selectedServerDocs) {
                const uploadName = renameMap[doc] && renameMap[doc].trim() ? renameMap[doc].trim() : doc;
                try {
                    console.log('overwriteCheck.checked:', overwriteCheck.checked);
                    let url = `/upload-pdf/upload-server-doc?filename=${encodeURIComponent(doc)}&container_name=${encodeURIComponent(selectedContainer)}`;
                    url += `&target_filename=${encodeURIComponent(uploadName)}`;
                    url += `&overwrite=${overwriteCheck.checked ? 'true' : 'false'}`;
                    console.log('UPLOAD URL:', url);
                    const response = await fetch(url, { method: 'POST' });
                    let result = {};
                    try { result = await response.json(); } catch { }
                    if (response.ok) {
                        successCount++;
                    } else if (response.status === 409 && result.detail && result.detail.includes('already exists in container')) {
                        alreadyExistsFiles.push(uploadName);
                        failCount++;
                    } else {
                        failCount++;
                    }
                } catch {
                    failCount++;
                }
            }
            let msg = '';
            if (successCount) {
                msg += `✅ Uploaded ${successCount} file(s)`;
            }
            if (alreadyExistsFiles.length) {
                msg += `${msg ? '<br>' : ''}⚠️ Already exists in container: ${alreadyExistsFiles.join(', ')}`;
                // Do not change selectedFile background/border color
            } else {
                // Reset highlight if not already exists
                selectedFile.style.background = '#dbf3f3';
                selectedFile.style.border = '';
            }
            if (failCount && (!alreadyExistsFiles.length || failCount > alreadyExistsFiles.length)) {
                msg += `${msg ? '<br>' : ''}❌ Upload failed for ${failCount} file(s).`;
            }
            // If only alreadyExistsFiles, treat as warning not error
            let resultType = 'success';
            if (!successCount && alreadyExistsFiles.length) {
                resultType = 'warning';
            } else if (!successCount && failCount) {
                resultType = 'error';
            }
            showResult(msg, resultType);
            selectedServerDocs = [];
            renameMap = {};
            setTimeout(() => {
                selectedFile.style.display = 'none';
                selectedFile.style.background = '#dbf3f3';
                selectedFile.style.border = '';
            }, 2000);
            Array.from(serverDocIcons.children).forEach(child => {
                child.style.border = '1.5px solid #e9ecef';
                child.style.boxShadow = '0 2px 8px rgba(0,0,0,0.06)';
            });
            uploadBtn.disabled = true;
            document.getElementById('renameInputs').innerHTML = '';
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 1000);
        });
        
        // Container selection handler
        containerSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                loadFilesFromContainer(e.target.value);
            } else {
                displayFiles([]);
            }
        });

        // Refresh button handler
        refreshBtn.addEventListener('click', async () => {
            refreshBtn.classList.add('spinning');
            hideResult(); // Clear any existing messages
            await loadFilesList();
            refreshBtn.classList.remove('spinning');
        });

        // No local file selection needed
        // Multiple selection enabled for server documents

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // No local file upload function needed

        async function loadFilesList() {
            // Load containers first, then files from the selected container
            await loadContainers();

            const selectedContainer = containerSelect.value;
            if (selectedContainer) {
                await loadFilesFromContainer(selectedContainer);
            }
        }

        async function loadContainers() {
            try {
                const response = await fetch('/upload-pdf/list-containers');
                const result = await response.json();

                containers = result.containers || [];

                // Clear and populate both container dropdowns
                containerSelect.innerHTML = '<option value="">Select a container...</option>';
                uploadContainerSelect.innerHTML = '<option value="">Select container for upload...</option>';

                containers.forEach(container => {
                    // For file listing dropdown
                    const option1 = document.createElement('option');
                    option1.value = container.name;
                    option1.textContent = `${container.name} (${container.last_modified ? new Date(container.last_modified).toLocaleDateString() : 'Unknown date'})`;
                    containerSelect.appendChild(option1);

                    // For upload dropdown
                    const option2 = document.createElement('option');
                    option2.value = container.name;
                    option2.textContent = container.name;
                    uploadContainerSelect.appendChild(option2);
                });

                // Auto-select the first container for file listing
                if (containers.length > 0) {
                    containerSelect.value = containers[0].name;
                    await loadFilesFromContainer(containers[0].name);
                }

            } catch (error) {
                containerSelect.innerHTML = '<option value="">Failed to load containers</option>';
                uploadContainerSelect.innerHTML = '<option value="">Failed to load containers</option>';
                console.error('Failed to load containers:', error);
            }
        }

        async function loadFilesFromContainer(containerName) {
            try {
                const response = await fetch(`/upload-pdf/list-files/${containerName}`);
                allFiles = await response.json();

                displayFiles(allFiles);

            } catch (error) {
                filesList.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        ❌ Failed to load files from ${containerName}: ${error.message}
                    </div>
                `;
            }
        }

        function displayFiles(files) {
            const selectedContainer = containerSelect.value;
            const containerInfo = selectedContainer ? ` from "${selectedContainer}"` : '';

            if (files.length === 0) {
                filesList.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        No files found${containerInfo}
                    </div>
                `;
            } else {
                filesList.innerHTML = '';
                files.forEach(file => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-item';

                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'file-icon';
                    iconDiv.textContent = '📄';

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'file-info';
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'file-name';
                    nameDiv.textContent = file;
                    const sizeDiv = document.createElement('div');
                    sizeDiv.className = 'file-size';
                    sizeDiv.style.fontSize = '0.8em';
                    sizeDiv.style.color = '#6c757d';
                    sizeDiv.textContent = `Container: ${selectedContainer || 'Default'}`;
                    infoDiv.appendChild(nameDiv);
                    infoDiv.appendChild(sizeDiv);

                    // Delete button (top right corner)
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Delete file';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '10px';
                    deleteBtn.style.right = '10px';
                    deleteBtn.style.background = '#fff';
                    deleteBtn.style.color = '#dc3545';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.borderRadius = '50%';
                    deleteBtn.style.width = '28px';
                    deleteBtn.style.height = '28px';
                    deleteBtn.style.fontSize = '1.3em';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.transition = 'background 0.2s, color 0.2s';
                    deleteBtn.style.fontWeight = 'bold';
                    deleteBtn.style.lineHeight = '1.1';
                    deleteBtn.style.boxShadow = '0 2px 8px rgba(220,53,69,0.08)';
                    deleteBtn.addEventListener('mouseenter', () => {
                        deleteBtn.style.background = '#ffe6ea';
                        deleteBtn.style.color = '#a71d2a';
                    });
                    deleteBtn.addEventListener('mouseleave', () => {
                        deleteBtn.style.background = '#fff';
                        deleteBtn.style.color = '#dc3545';
                    });
                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (!selectedContainer) {
                            const errorMsg = '❌ No container selected. Cannot delete file.';
                            showResult(errorMsg, 'error');
                            return;
                        }
                        if (!confirm(`Delete file '${file}' from container '${selectedContainer}'?`)) return;
                        deleteBtn.disabled = true;
                        deleteBtn.innerHTML = '⏳';
                        try {
                            const url = `/upload-pdf/delete-file-from-blob?filename=${encodeURIComponent(file)}&container_name=${encodeURIComponent(selectedContainer)}`;
                            const response = await fetch(url, { method: 'DELETE' });
                            
                            if (response.ok) {
                                let result = {};
                                try { 
                                    result = await response.json(); 
                                } catch (e) { 
                                    result = { message: 'File deleted successfully' }; 
                                }
                                const successMsg = `🗑️ File "${file}" deleted successfully from container "${selectedContainer}"`;
                                showContainerFilesMessage(successMsg, 'success');
                                itemDiv.remove();
                            } else if (response.status === 404) {
                                const errorMsg = `❌ File "${file}" not found in container "${selectedContainer}"`;
                                showResult(errorMsg, 'error');
                                deleteBtn.disabled = false;
                                deleteBtn.innerHTML = '&times;';
                            } else {
                                let result = {};
                                try { 
                                    result = await response.json(); 
                                } catch (e) { 
                                    result = { detail: 'Delete operation failed' }; 
                                }
                                const errorMsg = `❌ Failed to delete "${file}": ${result.detail || 'Unknown error'}`;
                                showResult(errorMsg, 'error');
                                deleteBtn.disabled = false;
                                deleteBtn.innerHTML = '&times;';
                            }
                        } catch (error) {
                            const errorMsg = `❌ Delete failed for "${file}": ${error.message}`;
                            showResult(errorMsg, 'error');
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = '&times;';
                        }
                    });

                    itemDiv.appendChild(iconDiv);
                    itemDiv.appendChild(infoDiv);
                    itemDiv.appendChild(deleteBtn);
                    filesList.appendChild(itemDiv);
                });
            }
        }

        let resultMsgTimeout;
        function showResult(message, type) {
            resultMessage.innerHTML = message;
            resultMessage.className = `result-message ${type}`;
            resultMessage.style.display = 'block';
            if (resultMsgTimeout) clearTimeout(resultMsgTimeout);
            resultMsgTimeout = setTimeout(() => {
                resultMessage.style.display = 'none';
            }, 3500);
        }

        function hideResult() {
            resultMessage.style.display = 'none';
        }

        // Load files list on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadFilesList();
            setupServerDocPicker();
        });
    </script>
</body>

</html>